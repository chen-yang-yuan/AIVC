map_chr(~ paste(.x, collapse = ", "))) %>%
select(ID, Description, pvalue, core_20) %>%
rename(core_enrichment_top20 = core_20)
write.csv(simplified_df, paste0(gsea_dir, "/", strsplit(file, ".csv")[[1]][1], "_simplified.csv"), row.names = FALSE)
print(paste0(file, "processed!"))
# # Ridge plot
# gsea_res@result <- result_df
# png(here::here(paste0("output/SG_subtype/GSEA_results/subtype_", i, ".png")), width = 10, height = 6, units = "in", res = 300)
# p <- ridgeplot(gsea_res, showCategory = 10) +
#   ggplot2::theme(axis.text.y = element_text(size = 15)) +
#   ggplot2::ylab(NULL)
# print(p)
# dev.off()
}
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(ggplot2)
library(msigdbr)
library(tidyverse)
here::i_am("code/2_outcome/GSEA.R")
# Settings
data <- "Xenium_5K_BC"
gene_dir <- file.path(here::here(paste0("output/", data)), "DE_genes")
gsea_dir <- file.path(here::here(paste0("output/", data)), "GSEA_results")
if (dir.exists(gsea_dir)) {
unlink(gsea_dir, recursive = TRUE)
}
dir.create(gsea_dir)
# Retrieve hallmark gene sets for Homo sapiens
hallmark_sets <- msigdbr(species = "Homo sapiens", category = "H")
for (file in list.files(gene_dir)){
if (stringr::str_detect(file, "Away") | stringr::str_detect(file, "Low")){
next
}
# Read data
df <- read.csv(paste0(gene_dir, "/", file))
if (dim(df)[1] <= 20){
next
}
# df <- df[df$pvals_adj < 0.05, ]
# Prepare named vector for GSEA
if (file == "SG_high_count_genes.csv"){
gene_list <- df %>%
dplyr::select(gene, sg_counts) %>%
dplyr::arrange(desc(sg_counts)) %>%
head(500)
gene_list_vector <- gene_list$sg_counts
names(gene_list_vector) <- gene_list$gene
}else{
gene_list <- df %>%
dplyr::select(names, logfc) %>%
dplyr::arrange(desc(logfc))
gene_list_vector <- gene_list$logfc
names(gene_list_vector) <- gene_list$names
}
# (Optional) remove duplicates and NA values
gene_list_vector <- gene_list_vector[!is.na(gene_list_vector)]
gene_list_vector <- sort(gene_list_vector, decreasing = TRUE)
# Run GSEA
gsea_res <- GSEA(geneList = gene_list_vector, TERM2GENE = hallmark_sets %>% dplyr::select(gs_name, gene_symbol), pvalueCutoff = 0.5, verbose = TRUE)
# Save GSEA results
result_df <- as.data.frame(gsea_res) %>%
mutate(label_clean = str_remove(ID, "^HALLMARK_"),
label_clean = str_replace_all(label_clean, "_", " "),
label_clean = str_to_title(label_clean),
Description = label_clean)
write.csv(result_df, paste0(gsea_dir, "/", file), row.names = FALSE)
# If no results, skip
if (nrow(result_df) == 0) {
message(paste0("No enriched terms for ", file, " — skipping simplified export."))
next
}
# Save simplified results
simplified_df <- result_df %>%
mutate(core_20 = core_enrichment %>%
str_split("/") %>%
map(~ .x[1:min(20, length(.x))]) %>%
map_chr(~ paste(.x, collapse = ", "))) %>%
select(ID, Description, pvalue, core_20) %>%
rename(core_enrichment_top20 = core_20)
write.csv(simplified_df, paste0(gsea_dir, "/", strsplit(file, ".csv")[[1]][1], "_simplified.csv"), row.names = FALSE)
print(paste0(file, "processed!"))
# # Ridge plot
# gsea_res@result <- result_df
# png(here::here(paste0("output/SG_subtype/GSEA_results/subtype_", i, ".png")), width = 10, height = 6, units = "in", res = 300)
# p <- ridgeplot(gsea_res, showCategory = 10) +
#   ggplot2::theme(axis.text.y = element_text(size = 15)) +
#   ggplot2::ylab(NULL)
# print(p)
# dev.off()
}
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(ggplot2)
library(msigdbr)
library(tidyverse)
here::i_am("code/2_outcome/GSEA.R")
# Settings
data <- "Xenium_5K_BC"
gene_dir <- file.path(here::here(paste0("output/", data)), "DE_genes")
gsea_dir <- file.path(here::here(paste0("output/", data)), "GSEA_results")
if (dir.exists(gsea_dir)) {
unlink(gsea_dir, recursive = TRUE)
}
dir.create(gsea_dir)
# Retrieve hallmark gene sets for Homo sapiens
hallmark_sets <- msigdbr(species = "Homo sapiens", category = "H")
for (file in list.files(gene_dir)){
if (stringr::str_detect(file, "Away") | stringr::str_detect(file, "Low")){
next
}
# Read data
df <- read.csv(paste0(gene_dir, "/", file))
if (dim(df)[1] <= 20){
next
}
# df <- df[df$pvals_adj < 0.05, ]
# Prepare named vector for GSEA
if (file == "SG_high_count_genes.csv"){
gene_list <- df %>%
dplyr::select(gene, sg_counts) %>%
dplyr::arrange(desc(sg_counts)) %>%
head(500)
gene_list_vector <- gene_list$sg_counts
names(gene_list_vector) <- gene_list$gene
}else{
gene_list <- df %>%
dplyr::select(names, logfc) %>%
dplyr::arrange(desc(logfc))
gene_list_vector <- gene_list$logfc
names(gene_list_vector) <- gene_list$names
}
# (Optional) remove duplicates and NA values
gene_list_vector <- gene_list_vector[!is.na(gene_list_vector)]
gene_list_vector <- sort(gene_list_vector, decreasing = TRUE)
# Run GSEA
gsea_res <- GSEA(geneList = gene_list_vector, TERM2GENE = hallmark_sets %>% dplyr::select(gs_name, gene_symbol), pvalueCutoff = 0.5, verbose = TRUE)
# Save GSEA results
result_df <- as.data.frame(gsea_res) %>%
mutate(label_clean = str_remove(ID, "^HALLMARK_"),
label_clean = str_replace_all(label_clean, "_", " "),
label_clean = str_to_title(label_clean),
Description = label_clean)
write.csv(result_df, paste0(gsea_dir, "/", file), row.names = FALSE)
# If no results, skip
if (nrow(result_df) == 0) {
message(paste0("No enriched terms for ", file, " — skipping simplified export."))
next
}
# Save simplified results
simplified_df <- result_df %>%
mutate(core_20 = core_enrichment %>%
str_split("/") %>%
map(~ .x[1:min(20, length(.x))]) %>%
map_chr(~ paste(.x, collapse = ", "))) %>%
select(ID, Description, pvalue, core_20) %>%
rename(core_enrichment_top20 = core_20)
write.csv(simplified_df, paste0(gsea_dir, "/", strsplit(file, ".csv")[[1]][1], "_simplified.csv"), row.names = FALSE)
print(paste0(file, "processed!"))
}
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(ggplot2)
library(msigdbr)
library(tidyverse)
here::i_am("code/2_outcome/GSEA.R")
# Settings
data <- "Xenium_5K_OC"
gene_dir <- file.path(here::here(paste0("output/", data)), "DE_genes")
gsea_dir <- file.path(here::here(paste0("output/", data)), "GSEA_results")
if (dir.exists(gsea_dir)) {
unlink(gsea_dir, recursive = TRUE)
}
dir.create(gsea_dir)
# Retrieve hallmark gene sets for Homo sapiens
hallmark_sets <- msigdbr(species = "Homo sapiens", category = "H")
for (file in list.files(gene_dir)){
if (stringr::str_detect(file, "Away") | stringr::str_detect(file, "Low")){
next
}
# Read data
df <- read.csv(paste0(gene_dir, "/", file))
if (dim(df)[1] <= 20){
next
}
# df <- df[df$pvals_adj < 0.05, ]
# Prepare named vector for GSEA
if (file == "SG_high_count_genes.csv"){
gene_list <- df %>%
dplyr::select(gene, sg_counts) %>%
dplyr::arrange(desc(sg_counts)) %>%
head(500)
gene_list_vector <- gene_list$sg_counts
names(gene_list_vector) <- gene_list$gene
}else{
gene_list <- df %>%
dplyr::select(names, logfc) %>%
dplyr::arrange(desc(logfc))
gene_list_vector <- gene_list$logfc
names(gene_list_vector) <- gene_list$names
}
# (Optional) remove duplicates and NA values
gene_list_vector <- gene_list_vector[!is.na(gene_list_vector)]
gene_list_vector <- sort(gene_list_vector, decreasing = TRUE)
# Run GSEA
gsea_res <- GSEA(geneList = gene_list_vector, TERM2GENE = hallmark_sets %>% dplyr::select(gs_name, gene_symbol), pvalueCutoff = 0.5, verbose = TRUE)
# Save GSEA results
result_df <- as.data.frame(gsea_res) %>%
mutate(label_clean = str_remove(ID, "^HALLMARK_"),
label_clean = str_replace_all(label_clean, "_", " "),
label_clean = str_to_title(label_clean),
Description = label_clean)
write.csv(result_df, paste0(gsea_dir, "/", file), row.names = FALSE)
# If no results, skip
if (nrow(result_df) == 0) {
message(paste0("No enriched terms for ", file, " — skipping simplified export."))
next
}
# Save simplified results
simplified_df <- result_df %>%
mutate(core_20 = core_enrichment %>%
str_split("/") %>%
map(~ .x[1:min(20, length(.x))]) %>%
map_chr(~ paste(.x, collapse = ", "))) %>%
select(ID, Description, pvalue, core_20) %>%
rename(core_enrichment_top20 = core_20)
write.csv(simplified_df, paste0(gsea_dir, "/", strsplit(file, ".csv")[[1]][1], "_simplified.csv"), row.names = FALSE)
print(paste0(file, "processed!"))
}
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(ggplot2)
library(msigdbr)
library(tidyverse)
here::i_am("code/2_outcome/GSEA.R")
# Settings
data <- "Xenium_5K_OC"
gene_dir <- file.path(here::here(paste0("output/", data)), "DE_genes")
gsea_dir <- file.path(here::here(paste0("output/", data)), "GSEA_results")
if (dir.exists(gsea_dir)) {
unlink(gsea_dir, recursive = TRUE)
}
dir.create(gsea_dir)
# Retrieve hallmark gene sets for Homo sapiens
hallmark_sets <- msigdbr(species = "Homo sapiens", category = "H")
for (file in list.files(gene_dir)){
if (stringr::str_detect(file, "Away") | stringr::str_detect(file, "Low")){
next
}
# Read data
df <- read.csv(paste0(gene_dir, "/", file))
if (dim(df)[1] <= 20){
next
}
# df <- df[df$pvals_adj < 0.05, ]
# Prepare named vector for GSEA
if (file == "SG_high_count_genes.csv"){
gene_list <- df %>%
dplyr::select(gene, sg_counts) %>%
dplyr::arrange(desc(sg_counts)) %>%
head(500)
gene_list_vector <- gene_list$sg_counts
names(gene_list_vector) <- gene_list$gene
}else{
gene_list <- df %>%
dplyr::select(names, logfc) %>%
dplyr::arrange(desc(logfc))
gene_list_vector <- gene_list$logfc
names(gene_list_vector) <- gene_list$names
}
# (Optional) remove duplicates and NA values
gene_list_vector <- gene_list_vector[!is.na(gene_list_vector)]
gene_list_vector <- sort(gene_list_vector, decreasing = TRUE)
# Run GSEA
gsea_res <- GSEA(geneList = gene_list_vector, TERM2GENE = hallmark_sets %>% dplyr::select(gs_name, gene_symbol), pvalueCutoff = 0.5, verbose = TRUE)
# Save GSEA results
result_df <- as.data.frame(gsea_res) %>%
mutate(label_clean = str_remove(ID, "^HALLMARK_"),
label_clean = str_replace_all(label_clean, "_", " "),
label_clean = str_to_title(label_clean),
Description = label_clean)
write.csv(result_df, paste0(gsea_dir, "/", file), row.names = FALSE)
# If no results, skip
if (nrow(result_df) == 0) {
message(paste0("No enriched terms for ", file, " — skipping simplified export."))
next
}
# Save simplified results
simplified_df <- result_df %>%
mutate(core_20 = core_enrichment %>%
str_split("/") %>%
map(~ .x[1:min(20, length(.x))]) %>%
map_chr(~ paste(.x, collapse = ", "))) %>%
select(ID, Description, pvalue, core_20) %>%
rename(core_enrichment_top20 = core_20)
write.csv(simplified_df, paste0(gsea_dir, "/", strsplit(file, ".csv")[[1]][1], "_simplified.csv"), row.names = FALSE)
print(paste0(file, "processed!"))
}
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(ggplot2)
library(msigdbr)
library(tidyverse)
here::i_am("code/2_outcome/GSEA.R")
# Settings
data <- "Xenium_5K_OC"
gene_dir <- file.path(here::here(paste0("output/", data)), "DE_genes")
gsea_dir <- file.path(here::here(paste0("output/", data)), "GSEA_results")
if (dir.exists(gsea_dir)) {
unlink(gsea_dir, recursive = TRUE)
}
dir.create(gsea_dir)
# Retrieve hallmark gene sets for Homo sapiens
hallmark_sets <- msigdbr(species = "Homo sapiens", category = "H")
for (file in list.files(gene_dir)){
if (stringr::str_detect(file, "Away") | stringr::str_detect(file, "Low")){
next
}
# Read data
df <- read.csv(paste0(gene_dir, "/", file))
if (dim(df)[1] <= 20){
next
}
# df <- df[df$pvals_adj < 0.05, ]
# Prepare named vector for GSEA
if (file == "SG_high_count_genes.csv"){
gene_list <- df %>%
dplyr::select(gene, sg_counts) %>%
dplyr::arrange(desc(sg_counts)) %>%
head(1000)
gene_list_vector <- gene_list$sg_counts
names(gene_list_vector) <- gene_list$gene
}else{
gene_list <- df %>%
dplyr::select(names, logfc) %>%
dplyr::arrange(desc(logfc))
gene_list_vector <- gene_list$logfc
names(gene_list_vector) <- gene_list$names
}
# (Optional) remove duplicates and NA values
gene_list_vector <- gene_list_vector[!is.na(gene_list_vector)]
gene_list_vector <- sort(gene_list_vector, decreasing = TRUE)
# Run GSEA
gsea_res <- GSEA(geneList = gene_list_vector, TERM2GENE = hallmark_sets %>% dplyr::select(gs_name, gene_symbol), pvalueCutoff = 0.5, verbose = TRUE)
# Save GSEA results
result_df <- as.data.frame(gsea_res) %>%
mutate(label_clean = str_remove(ID, "^HALLMARK_"),
label_clean = str_replace_all(label_clean, "_", " "),
label_clean = str_to_title(label_clean),
Description = label_clean)
write.csv(result_df, paste0(gsea_dir, "/", file), row.names = FALSE)
# If no results, skip
if (nrow(result_df) == 0) {
message(paste0("No enriched terms for ", file, " — skipping simplified export."))
next
}
# Save simplified results
simplified_df <- result_df %>%
mutate(core_20 = core_enrichment %>%
str_split("/") %>%
map(~ .x[1:min(20, length(.x))]) %>%
map_chr(~ paste(.x, collapse = ", "))) %>%
select(ID, Description, pvalue, core_20) %>%
rename(core_enrichment_top20 = core_20)
write.csv(simplified_df, paste0(gsea_dir, "/", strsplit(file, ".csv")[[1]][1], "_simplified.csv"), row.names = FALSE)
print(paste0(file, "processed!"))
}
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(ggplot2)
library(msigdbr)
library(tidyverse)
here::i_am("code/2_outcome/GSEA.R")
# Settings
data <- "Xenium_5K_OC"
gene_dir <- file.path(here::here(paste0("output/", data)), "DE_genes")
gsea_dir <- file.path(here::here(paste0("output/", data)), "GSEA_results")
if (dir.exists(gsea_dir)) {
unlink(gsea_dir, recursive = TRUE)
}
dir.create(gsea_dir)
# Retrieve hallmark gene sets for Homo sapiens
hallmark_sets <- msigdbr(species = "Homo sapiens", category = "H")
for (file in list.files(gene_dir)){
if (stringr::str_detect(file, "Away") | stringr::str_detect(file, "Low")){
next
}
# Read data
df <- read.csv(paste0(gene_dir, "/", file))
if (dim(df)[1] <= 20){
next
}
# df <- df[df$pvals_adj < 0.05, ]
# Prepare named vector for GSEA
if (file == "SG_high_count_genes.csv"){
gene_list <- df %>%
dplyr::select(gene, sg_counts) %>%
dplyr::arrange(desc(sg_counts)) %>%
head(1000)
gene_list_vector <- gene_list$sg_counts
names(gene_list_vector) <- gene_list$gene
}else{
gene_list <- df %>%
dplyr::select(names, logfc) %>%
dplyr::arrange(desc(logfc))
gene_list_vector <- gene_list$logfc
names(gene_list_vector) <- gene_list$names
}
# (Optional) remove duplicates and NA values
gene_list_vector <- gene_list_vector[!is.na(gene_list_vector)]
gene_list_vector <- sort(gene_list_vector, decreasing = TRUE)
# Run GSEA
gsea_res <- GSEA(geneList = gene_list_vector, TERM2GENE = hallmark_sets %>% dplyr::select(gs_name, gene_symbol), pvalueCutoff = 0.5, verbose = TRUE)
# Save GSEA results
result_df <- as.data.frame(gsea_res) %>%
mutate(label_clean = str_remove(ID, "^HALLMARK_"),
label_clean = str_replace_all(label_clean, "_", " "),
label_clean = str_to_title(label_clean),
Description = label_clean)
write.csv(result_df, paste0(gsea_dir, "/", file), row.names = FALSE)
# If no results, skip
if (nrow(result_df) == 0) {
message(paste0("No enriched terms for ", file, " — skipping simplified export."))
next
}
# Save simplified results
simplified_df <- result_df %>%
mutate(core_20 = core_enrichment %>%
str_split("/") %>%
map(~ .x[1:min(20, length(.x))]) %>%
map_chr(~ paste(.x, collapse = ", "))) %>%
select(ID, Description, pvalue, core_20) %>%
rename(core_enrichment_top20 = core_20)
write.csv(simplified_df, paste0(gsea_dir, "/", strsplit(file, ".csv")[[1]][1], "_simplified.csv"), row.names = FALSE)
print(paste0(file, " processed!"))
}
library(clusterProfiler)
library(dplyr)
library(enrichplot)
library(ggplot2)
library(msigdbr)
library(tidyverse)
here::i_am("code/2_outcome/GSEA.R")
# Settings
data <- "Xenium_5K_BC"
gene_dir <- file.path(here::here(paste0("output/", data)), "DE_genes")
gsea_dir <- file.path(here::here(paste0("output/", data)), "GSEA_results")
if (dir.exists(gsea_dir)) {
unlink(gsea_dir, recursive = TRUE)
}
dir.create(gsea_dir)
# Retrieve hallmark gene sets for Homo sapiens
hallmark_sets <- msigdbr(species = "Homo sapiens", category = "H")
for (file in list.files(gene_dir)){
if (stringr::str_detect(file, "Away") | stringr::str_detect(file, "Low")){
next
}
# Read data
df <- read.csv(paste0(gene_dir, "/", file))
if (dim(df)[1] <= 20){
next
}
# df <- df[df$pvals_adj < 0.05, ]
# Prepare named vector for GSEA
if (file == "SG_high_count_genes.csv"){
gene_list <- df %>%
dplyr::select(gene, sg_counts) %>%
dplyr::arrange(desc(sg_counts)) %>%
head(1000)
gene_list_vector <- gene_list$sg_counts
names(gene_list_vector) <- gene_list$gene
}else{
gene_list <- df %>%
dplyr::select(names, logfc) %>%
dplyr::arrange(desc(logfc))
gene_list_vector <- gene_list$logfc
names(gene_list_vector) <- gene_list$names
}
# (Optional) remove duplicates and NA values
gene_list_vector <- gene_list_vector[!is.na(gene_list_vector)]
gene_list_vector <- sort(gene_list_vector, decreasing = TRUE)
# Run GSEA
gsea_res <- GSEA(geneList = gene_list_vector, TERM2GENE = hallmark_sets %>% dplyr::select(gs_name, gene_symbol), pvalueCutoff = 0.5, verbose = TRUE)
# Save GSEA results
result_df <- as.data.frame(gsea_res) %>%
mutate(label_clean = str_remove(ID, "^HALLMARK_"),
label_clean = str_replace_all(label_clean, "_", " "),
label_clean = str_to_title(label_clean),
Description = label_clean)
write.csv(result_df, paste0(gsea_dir, "/", file), row.names = FALSE)
# If no results, skip
if (nrow(result_df) == 0) {
message(paste0("No enriched terms for ", file, " — skipping simplified export."))
next
}
# Save simplified results
simplified_df <- result_df %>%
mutate(core_20 = core_enrichment %>%
str_split("/") %>%
map(~ .x[1:min(20, length(.x))]) %>%
map_chr(~ paste(.x, collapse = ", "))) %>%
select(ID, Description, pvalue, core_20) %>%
rename(core_enrichment_top20 = core_20)
write.csv(simplified_df, paste0(gsea_dir, "/", strsplit(file, ".csv")[[1]][1], "_simplified.csv"), row.names = FALSE)
print(paste0(file, " processed!"))
}
